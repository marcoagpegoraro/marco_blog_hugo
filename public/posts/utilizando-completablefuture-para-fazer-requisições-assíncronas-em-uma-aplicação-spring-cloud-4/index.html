<!DOCTYPE html>
<html lang="en">

    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><title>Utilizando CompletableFuture para fazer requisi√ß√µes ass√≠ncronas em uma aplica√ß√£o Spring Cloud &ndash; Blog do Marco(Marco&#39;s Blog)</title>
<meta name="description" content="Hello, my name is Marco, welcome to my personal blog, here i write posts about tecnology, programming, life, tech reviews among other things.">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="http://localhost:1313/css/palettes/base16-dark.css">
<link rel="stylesheet" href="http://localhost:1313/css/risotto.css">
<link rel="stylesheet" href="http://localhost:1313/css/custom.css">







</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
      <li class="nomarker"><h1 class="page__logo"><a href="http://localhost:1313/" class="page__logo-inner">Blog do Marco(Marco&#39;s Blog)</a></h1></li>
    
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Utilizando CompletableFuture para fazer requisi√ß√µes ass√≠ncronas em uma aplica√ß√£o Spring Cloud</h1>
    </header>
    <div class="content__body">
        <p><img src="https://miro.medium.com/v2/resize:fit:1400/1*eWlh07xrpxE2LHGjGqqjzg.png" alt="">Com um mundo cada vez mais demandando velocidade e usu√°rios cada vez mais exigentes, surge a necessidade de realizar otimiza√ß√µes em aplica√ß√µes rest para o tempo de requisi√ß√£o ser o menor poss√≠vel.</p>
<p>Imagine um cen√°rio onde voc√™ possui um orquestrador e para devolver a resposta para seu usu√°rio, voc√™ precisa realizar outras requisi√ß√µes <em>HTTP</em> em outros microsservi√ßos,</p>
<p>Para demonstrar como realizar requisi√ß√µes ass√≠ncronas no <em>Spring</em> <em>Cloud</em> utilizando o <em>CompletableFuture</em> do Java 8, ser√° criado um projeto orquestrador que retornar√° os dados de um usu√°rio, e para agrupar os dados desse usu√°rio, ser√° necess√°rio fazer tr√™s requisi√ß√µes para tr√™s <em>REST APIs</em> diferentes. o intuito ser√° mostrar como realizar essas requisi√ß√µes simultaneamente e n√£o sequenciais, diminuindo assim o tempo de resposta da <em>API</em>.</p>
<h1 id="exemplo-pr√°tico">Exemplo pr√°tico</h1>
<p>A aplica√ß√£o principal ser√° uma aplica√ß√£o <em>spring</em> <em>cloud</em> criada no site <a href="https://start.spring.io/">https://start.spring.io</a> como mostrado na figura 1:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*HYUHDAVQCp9BXo7JjlOwlA.png" alt=""></p>
<p>Figura 1: Configura√ß√£o utilizada no microservi√ßo orquestrador</p>
<p>Ser√° utilizado a dependencia OpenFeign para realizar as requisi√ß√µes Http para os microsservi√ßos secund√°rios e o lombok para facilitar a cria√ß√£o das classes Java.</p>
<h2 id="cria√ß√£o-dos-microsservi√ßos-que-ser√£o-consumidos">Cria√ß√£o dos microsservi√ßos que ser√£o consumidos</h2>
<p>Para simular os servi√ßos a serem consumidos, foi feito tr√™s scripts utilizando Node.js com o framework Express.js, e para roda-los simultaneamente, foi utilizado um script para rodar tr√™s processos do Node para n√£o ter nenhuma interfer√™ncia entre os servi√ßos.</p>
<p>A figura 2 mostra respectivamente os scripts do servi√ßo um, que ser√° utilizado para buscar informa√ß√µes de musicas do usu√°rio, servi√ßo dois que ser√° utilizado para buscar informa√ß√µes gerais e servi√ßo tr√™s que ser√° utilizado para buscar informa√ß√µes de postagens desse usu√°rio. Logo abaixo, existe o script <em>bash</em> para rodar os servers simultaneamente e logo ao lado, a declara√ß√£o de uma fun√ß√£o <em>sleepOneSecond</em> que ser√° utilizada para simular um delay em um banco de dados fict√≠cio, o que n√£o existe no exemplo pois os dados est√£o <em>mockados</em>.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*gR1GPYGtHdJNgXrA_u0vQQ.png" alt=""></p>
<p>Figura 2 ‚Äî Estrutura dos servi√ßos em Node que ser√£o consumidos.</p>
<h2 id="preparando-o-orquestrador">Preparando o orquestrador</h2>
<p>Com o projeto criado no <em>Spring Initializr</em>, ser√° criado primeiramente algumas classes para preenchimento dos dados que ser√£o recebidos pela api, como pode ser visto na figura 3:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*4U7Uku3IJ7hSwxZyhXo4ZQ.png" alt=""></p>
<p>Figura 3 ‚Äî POJOs que ser√£o utilizadas no projeto, a classe UserResponse ser√° utilizada como a classe de sa√≠da do endpoint, j√° as demais ser√£o as classes que ser√£o preenchidas ao realizar as requisi√ß√µes.</p>
<p>Tamb√©m ser√° criado uma camada de <em>services</em> e <em>clients</em> na aplica√ß√£o, que ficar√° respons√°vel principalmente pela responsabilidade de realizar requisi√ß√µes <em>HTTP</em> e retornar um objeto para quem estiver consumindo a camada de <em>service</em>, bem semelhante o que existe no <em>framework frontend Angular</em>, a implementa√ß√£o pode ser vista na figura 4:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*hSKtoil1DrkreghWqmijJQ.png" alt=""></p>
<p>Figura 4 ‚Äî Classes respons√°veis por realizar as requisi√ß√µes HTTP, note que cada endpoint que ser√° chamado tem sua pr√≥pria camada de service e client.</p>
<p>Feito isso, agora ser√° estruturado o <em>controller</em> da aplica√ß√£o, a estrutura do m√©todo principal conter√° as tr√™s chamadas para os servi√ßos, logo em seguida, ser√° montado o objeto final do usu√°rio utilizando o padr√£o de projeto <em>Builder</em>, j√° implementado pelo plugin <em>Lombok</em>, a figura 5 demonstra como ficou o resultado final da classe:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*70ndlTX_to3ekmkSa31qPg.png" alt=""></p>
<p>Figura 5 ‚Äî Controller principal da aplica√ß√£o</p>
<blockquote>
<p>N√£o se esque√ßa de colocar a <em>annotation</em> @EnableFeignClients logo acima da classe <em>main</em> do seu projeto, para a inje√ß√£o de dependencia @Autowired do <em>Spring</em> funcionar corretamente.</p>
</blockquote>
<p>Observe que tamb√©m foi colocado um <em>println</em> para mostrar no console quanto tempo durou a requisi√ß√£o, agora subindo a aplica√ß√£o e enviando uma requisi√ß√£o pelo <em>postman</em>, verificamos que est√° tudo funcionando (lembre-se de subir as aplica√ß√µes em Node tamb√©m!) , como mostra a figura 6:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*NE8Gvg2oZYmL86xNURTMIA.png" alt=""></p>
<p>Figura 6 ‚Äî Resposta da API funcionando, i see this as an absolute win‚Ä¶ right?</p>
<p>Perceba que os dados foram retornados corretamente, por√©m perceba que o tempo da requisi√ß√£o ficou cerca de quatro segundos, o que, dependendo do caso de uso, pode ser bem lento.</p>
<p>Isto ocorre pois as requisi√ß√µes <em>HTTP</em> est√£o acontecendo uma atr√°s da outra, e se fosse poss√≠vel realizar todas as requisi√ß√µes ao mesmo tempo e s√≥ obter as respostas no momento de montar o objeto de sa√≠da da aplica√ß√£o? isto que ser√° feito a seguir!</p>
<p>A vers√£o 8 do Java possui uma API muito simples de ser utilizada chamada <em>CompletableFuture</em>, com ela, √© poss√≠vel solucionar o problema visto anteriormente com bastante facilidade, para demonstrar como √© utilizado, ser√° criado um novo m√©todo no <em>controller</em> s√≥ que desta vez, utilizado requisi√ß√µes ass√≠ncronas, como visto na figura 7:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*BOfXdmWv1x3FlQRsr41kmw.png" alt=""></p>
<p>Figura 7 ‚Äî Novo m√©todo utilizando a API do CompletableFuture.</p>
<p>A principal diferen√ßa do novo m√©todo para o antigo √© a de que utilizamos o <em>CompletableFuture.supplyAsync(Supplier<U> supplier)</em> e passamos como argumento um <em>supplier</em> retornando a fun√ß√£o no qual √© desejado o retorno, no caso, √© feito isso nas tr√™s chamadas <em>HTTP</em>, o que acontece por debaixo dos panos √© que cada supplyAsync cria uma nova thread para rodar a requisi√ß√£o paralelamente com a thread principal da aplica√ß√£o.</p>
<p>Outra principal diferen√ßa √© que o objeto que retornar√° das requisi√ß√µes √© do tipo <em>CompletableFuture<T></em>, isto acontece pois ainda n√£o existe esse objeto em mem√≥ria, j√° que ele ser√° obtido no futuro, ent√£o as linhas 61 at√© 66 ir√£o ser rodadas ao mesmo tempo sem uma bloquear a outra.</p>
<blockquote>
<p>Vale apontar tamb√©m que os m√©todos do service precisam ter a annotation @Async para sinalizar para o Spring que o m√©todo √© ass√≠ncrono, para mais detalhes, consultar o segundo link que est√° nas referencias no final do artigo.</p>
</blockquote>
<p>A aplica√ß√£o s√≥ ser√° bloqueante novamente quando √© feito um <em>.get()</em> no objeto de retorno, pois assim √© sinalizado para o Java que a aplica√ß√£o n√£o pode continuar a partir daquele ponto sem os dados retornados da API.</p>
<p>Com as altera√ß√µes feitas, ser√° feito ent√£o uma nova requisi√ß√£o pelo <em>postman</em> s√≥ que pelo novo endpoint, como mostra a figura 8:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Qfol7zdRSRfTy_AD3ezywg.png" alt=""></p>
<p>Figura 8 ‚Äî Requisi√ß√£o feita no novo <em>endpoint</em> usando programa√ß√£o ass√≠ncrona, observe que durou 1/3 do tempo original da requisi√ß√£o.</p>
<p>Com isso, √© poss√≠vel observar o ganho obtido utilizando programa√ß√£o ass√≠ncrona com CompletableFuture, que √© uma API que j√° est√° presente no Java 8 ou vers√µes mais novas.</p>
<p>Vou estar deixado meu Linkedin aqui no post caso algu√©m tenha alguma duvida, critica ou sugest√£o a respeito do artigo, eu ficaria bem feliz pelo feedback! tamb√©m estarei deixando o reposit√≥rio da aplica√ß√£o criada, junto com os scripts em Node utilizados para simular os microsservi√ßos</p>
<p>Until then, stay safe!</p>
<h2 id="marco-antonio-g---fatec-americana---campinas-s√£o-paulo-brazil--linkedinhttpswwwlinkedincominmarco-antonio-goncalvessourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">Marco Antonio G. - FATEC Americana - Campinas, S√£o Paulo, Brazil | LinkedIn</a></h2>
<h3 id="view-marco-antonio-gs-profile-on-linkedin-the-worlds-largest-professional-community-marco-antonios-education-ishttpswwwlinkedincominmarco-antonio-goncalvessourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">View Marco Antonio G.&rsquo;s profile on LinkedIn, the world&rsquo;s largest professional community. Marco Antonio&rsquo;s education is‚Ä¶</a></h3>
<p><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">www.linkedin.com</a></p>
<h2 id="marcoagpegorarospring-cloud-requisicoes-assincronashttpsgithubcommarcoagpegorarospring-cloud-requisicoes-assincronassourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">marcoagpegoraro/spring-cloud-requisicoes-assincronas</a></h2>
<h3 id="contribute-to-marcoagpegorarospring-cloud-requisicoes-assincronas-development-by-creating-an-account-on-githubhttpsgithubcommarcoagpegorarospring-cloud-requisicoes-assincronassourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">Contribute to marcoagpegoraro/spring-cloud-requisicoes-assincronas development by creating an account on GitHub.</a></h3>
<p><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">github.com</a></p>
<h2 id="refer√™ncias">Refer√™ncias</h2>
<h2 id="completablefuture-java-platform-se-8-httpsdocsoraclecomjavase8docsapijavautilconcurrentcompletablefuturehtmlsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">CompletableFuture (Java Platform SE 8 )</a></h2>
<h3 id="supplyasync-returns-a-new-completablefuture-that-is-asynchronously-completed-by-a-task-running-in-the-given-executorhttpsdocsoraclecomjavase8docsapijavautilconcurrentcompletablefuturehtmlsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">supplyAsync Returns a new CompletableFuture that is asynchronously completed by a task running in the given executor‚Ä¶</a></h3>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">docs.oracle.com</a></p>
<h2 id="creating-asynchronous-methodshttpsspringioguidesgsasync-methodsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">Creating Asynchronous Methods</a></h2>
<h3 id="this-guide-walks-you-through-creating-asynchronous-queries-to-github-the-focus-is-on-the-asynchronous-part-a-featurehttpsspringioguidesgsasync-methodsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">This guide walks you through creating asynchronous queries to GitHub. The focus is on the asynchronous part, a feature‚Ä¶</a></h3>
<p><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">spring.io</a></p>

    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    <span class="about__logo" role="img">üíª</span>&nbsp;
    
<h1 class="about__title">Marco Pegoraro</h1>
<p class="about__description">Hello, my name is Marco, welcome to my personal blog, here i write posts about tecnology, programming, life, tech reviews among other things.</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/marcoagpegoraro" rel="me" aria-label="GitHub" title="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="mailto:marco@marcoagpegoraro.com.br" rel="me" aria-label="Email" title="Email"><i class="fa-solid fa-envelope" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://www.youtube.com/@marcoagpegoraro" rel="me" aria-label="Youtube" title="Youtube"><i class="fa-brands fa-youtube" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://www.linkedin.com/in/marco-antonio-goncalves" rel="me" aria-label="Linkedin" title="Linkedin"><i class="fa-brands fa-linkedin" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://medium.com/@tete5423" rel="me" aria-label="Medium" title="Medium"><i class="fa-brands fa-medium" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    
    
        <p>
            By Marco Pegoraro, 
            2020-08-22
        </p>
    

    

                </div>
            </section>

            <footer class="page__footer"><p>
    
    
    
    
    
    
    
    
      
      
          
            
            
                <br/><span class="active">$ echo $LANG<br/><b></b></span><br/>

            
          
      
    
</p>
<br /><br />
<p class="copyright">¬© <a href="https://marcoagpegoraro.com.br">Marco Pegoraro</a>.</p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
</footer>

        </div>
    </body>

</html>
