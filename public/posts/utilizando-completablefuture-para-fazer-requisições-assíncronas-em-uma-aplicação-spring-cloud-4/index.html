<!DOCTYPE html>
<html lang="en">

    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><title>Utilizando CompletableFuture para fazer requisições assíncronas em uma aplicação Spring Cloud &ndash; Blog do Marco(Marco&#39;s Blog)</title>


<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="http://localhost:1313/css/palettes/base16-dark.css">
<link rel="stylesheet" href="http://localhost:1313/css/risotto.css">
<link rel="stylesheet" href="http://localhost:1313/css/custom.css">







</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
      <li class="nomarker"><h1 class="page__logo"><a href="http://localhost:1313/" class="page__logo-inner">Blog do Marco(Marco&#39;s Blog)</a></h1></li>
    
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Utilizando CompletableFuture para fazer requisições assíncronas em uma aplicação Spring Cloud</h1>
    </header>
    <div class="content__body">
        <p><img src="https://miro.medium.com/v2/resize:fit:1400/1*eWlh07xrpxE2LHGjGqqjzg.png" alt="">Com um mundo cada vez mais demandando velocidade e usuários cada vez mais exigentes, surge a necessidade de realizar otimizações em aplicações rest para o tempo de requisição ser o menor possível.</p>
<p>Imagine um cenário onde você possui um orquestrador e para devolver a resposta para seu usuário, você precisa realizar outras requisições <em>HTTP</em> em outros microsserviços,</p>
<p>Para demonstrar como realizar requisições assíncronas no <em>Spring</em> <em>Cloud</em> utilizando o <em>CompletableFuture</em> do Java 8, será criado um projeto orquestrador que retornará os dados de um usuário, e para agrupar os dados desse usuário, será necessário fazer três requisições para três <em>REST APIs</em> diferentes. o intuito será mostrar como realizar essas requisições simultaneamente e não sequenciais, diminuindo assim o tempo de resposta da <em>API</em>.</p>
<h1 id="exemplo-prático">Exemplo prático</h1>
<p>A aplicação principal será uma aplicação <em>spring</em> <em>cloud</em> criada no site <a href="https://start.spring.io/">https://start.spring.io</a> como mostrado na figura 1:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*HYUHDAVQCp9BXo7JjlOwlA.png" alt=""></p>
<p>Figura 1: Configuração utilizada no microserviço orquestrador</p>
<p>Será utilizado a dependencia OpenFeign para realizar as requisições Http para os microsserviços secundários e o lombok para facilitar a criação das classes Java.</p>
<h2 id="criação-dos-microsserviços-que-serão-consumidos">Criação dos microsserviços que serão consumidos</h2>
<p>Para simular os serviços a serem consumidos, foi feito três scripts utilizando Node.js com o framework Express.js, e para roda-los simultaneamente, foi utilizado um script para rodar três processos do Node para não ter nenhuma interferência entre os serviços.</p>
<p>A figura 2 mostra respectivamente os scripts do serviço um, que será utilizado para buscar informações de musicas do usuário, serviço dois que será utilizado para buscar informações gerais e serviço três que será utilizado para buscar informações de postagens desse usuário. Logo abaixo, existe o script <em>bash</em> para rodar os servers simultaneamente e logo ao lado, a declaração de uma função <em>sleepOneSecond</em> que será utilizada para simular um delay em um banco de dados fictício, o que não existe no exemplo pois os dados estão <em>mockados</em>.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*gR1GPYGtHdJNgXrA_u0vQQ.png" alt=""></p>
<p>Figura 2 — Estrutura dos serviços em Node que serão consumidos.</p>
<h2 id="preparando-o-orquestrador">Preparando o orquestrador</h2>
<p>Com o projeto criado no <em>Spring Initializr</em>, será criado primeiramente algumas classes para preenchimento dos dados que serão recebidos pela api, como pode ser visto na figura 3:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*4U7Uku3IJ7hSwxZyhXo4ZQ.png" alt=""></p>
<p>Figura 3 — POJOs que serão utilizadas no projeto, a classe UserResponse será utilizada como a classe de saída do endpoint, já as demais serão as classes que serão preenchidas ao realizar as requisições.</p>
<p>Também será criado uma camada de <em>services</em> e <em>clients</em> na aplicação, que ficará responsável principalmente pela responsabilidade de realizar requisições <em>HTTP</em> e retornar um objeto para quem estiver consumindo a camada de <em>service</em>, bem semelhante o que existe no <em>framework frontend Angular</em>, a implementação pode ser vista na figura 4:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*hSKtoil1DrkreghWqmijJQ.png" alt=""></p>
<p>Figura 4 — Classes responsáveis por realizar as requisições HTTP, note que cada endpoint que será chamado tem sua própria camada de service e client.</p>
<p>Feito isso, agora será estruturado o <em>controller</em> da aplicação, a estrutura do método principal conterá as três chamadas para os serviços, logo em seguida, será montado o objeto final do usuário utilizando o padrão de projeto <em>Builder</em>, já implementado pelo plugin <em>Lombok</em>, a figura 5 demonstra como ficou o resultado final da classe:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*70ndlTX_to3ekmkSa31qPg.png" alt=""></p>
<p>Figura 5 — Controller principal da aplicação</p>
<blockquote>
<p>Não se esqueça de colocar a <em>annotation</em> @EnableFeignClients logo acima da classe <em>main</em> do seu projeto, para a injeção de dependencia @Autowired do <em>Spring</em> funcionar corretamente.</p>
</blockquote>
<p>Observe que também foi colocado um <em>println</em> para mostrar no console quanto tempo durou a requisição, agora subindo a aplicação e enviando uma requisição pelo <em>postman</em>, verificamos que está tudo funcionando (lembre-se de subir as aplicações em Node também!) , como mostra a figura 6:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*NE8Gvg2oZYmL86xNURTMIA.png" alt=""></p>
<p>Figura 6 — Resposta da API funcionando, i see this as an absolute win… right?</p>
<p>Perceba que os dados foram retornados corretamente, porém perceba que o tempo da requisição ficou cerca de quatro segundos, o que, dependendo do caso de uso, pode ser bem lento.</p>
<p>Isto ocorre pois as requisições <em>HTTP</em> estão acontecendo uma atrás da outra, e se fosse possível realizar todas as requisições ao mesmo tempo e só obter as respostas no momento de montar o objeto de saída da aplicação? isto que será feito a seguir!</p>
<p>A versão 8 do Java possui uma API muito simples de ser utilizada chamada <em>CompletableFuture</em>, com ela, é possível solucionar o problema visto anteriormente com bastante facilidade, para demonstrar como é utilizado, será criado um novo método no <em>controller</em> só que desta vez, utilizado requisições assíncronas, como visto na figura 7:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*BOfXdmWv1x3FlQRsr41kmw.png" alt=""></p>
<p>Figura 7 — Novo método utilizando a API do CompletableFuture.</p>
<p>A principal diferença do novo método para o antigo é a de que utilizamos o <em>CompletableFuture.supplyAsync(Supplier<!-- raw HTML omitted --> supplier)</em> e passamos como argumento um <em>supplier</em> retornando a função no qual é desejado o retorno, no caso, é feito isso nas três chamadas <em>HTTP</em>, o que acontece por debaixo dos panos é que cada supplyAsync cria uma nova thread para rodar a requisição paralelamente com a thread principal da aplicação.</p>
<p>Outra principal diferença é que o objeto que retornará das requisições é do tipo <em>CompletableFuture<!-- raw HTML omitted --></em>, isto acontece pois ainda não existe esse objeto em memória, já que ele será obtido no futuro, então as linhas 61 até 66 irão ser rodadas ao mesmo tempo sem uma bloquear a outra.</p>
<blockquote>
<p>Vale apontar também que os métodos do service precisam ter a annotation @Async para sinalizar para o Spring que o método é assíncrono, para mais detalhes, consultar o segundo link que está nas referencias no final do artigo.</p>
</blockquote>
<p>A aplicação só será bloqueante novamente quando é feito um <em>.get()</em> no objeto de retorno, pois assim é sinalizado para o Java que a aplicação não pode continuar a partir daquele ponto sem os dados retornados da API.</p>
<p>Com as alterações feitas, será feito então uma nova requisição pelo <em>postman</em> só que pelo novo endpoint, como mostra a figura 8:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Qfol7zdRSRfTy_AD3ezywg.png" alt=""></p>
<p>Figura 8 — Requisição feita no novo <em>endpoint</em> usando programação assíncrona, observe que durou 1/3 do tempo original da requisição.</p>
<p>Com isso, é possível observar o ganho obtido utilizando programação assíncrona com CompletableFuture, que é uma API que já está presente no Java 8 ou versões mais novas.</p>
<p>Vou estar deixado meu Linkedin aqui no post caso alguém tenha alguma duvida, critica ou sugestão a respeito do artigo, eu ficaria bem feliz pelo feedback! também estarei deixando o repositório da aplicação criada, junto com os scripts em Node utilizados para simular os microsserviços</p>
<p>Until then, stay safe!</p>
<h2 id="marco-antonio-g---fatec-americana---campinas-são-paulo-brazil--linkedinhttpswwwlinkedincominmarco-antonio-goncalvessourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">Marco Antonio G. - FATEC Americana - Campinas, São Paulo, Brazil | LinkedIn</a></h2>
<h3 id="view-marco-antonio-gs-profile-on-linkedin-the-worlds-largest-professional-community-marco-antonios-education-ishttpswwwlinkedincominmarco-antonio-goncalvessourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">View Marco Antonio G.&rsquo;s profile on LinkedIn, the world&rsquo;s largest professional community. Marco Antonio&rsquo;s education is…</a></h3>
<p><a href="https://www.linkedin.com/in/marco-antonio-goncalves/?source=post%5Fpage-----44dd721f60e9--------------------------------">www.linkedin.com</a></p>
<h2 id="marcoagpegorarospring-cloud-requisicoes-assincronashttpsgithubcommarcoagpegorarospring-cloud-requisicoes-assincronassourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">marcoagpegoraro/spring-cloud-requisicoes-assincronas</a></h2>
<h3 id="contribute-to-marcoagpegorarospring-cloud-requisicoes-assincronas-development-by-creating-an-account-on-githubhttpsgithubcommarcoagpegorarospring-cloud-requisicoes-assincronassourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">Contribute to marcoagpegoraro/spring-cloud-requisicoes-assincronas development by creating an account on GitHub.</a></h3>
<p><a href="https://github.com/marcoagpegoraro/spring-cloud-requisicoes-assincronas?source=post%5Fpage-----44dd721f60e9--------------------------------">github.com</a></p>
<h2 id="referências">Referências</h2>
<h2 id="completablefuture-java-platform-se-8-httpsdocsoraclecomjavase8docsapijavautilconcurrentcompletablefuturehtmlsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">CompletableFuture (Java Platform SE 8 )</a></h2>
<h3 id="supplyasync-returns-a-new-completablefuture-that-is-asynchronously-completed-by-a-task-running-in-the-given-executorhttpsdocsoraclecomjavase8docsapijavautilconcurrentcompletablefuturehtmlsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">supplyAsync Returns a new CompletableFuture that is asynchronously completed by a task running in the given executor…</a></h3>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html?source=post%5Fpage-----44dd721f60e9--------------------------------">docs.oracle.com</a></p>
<h2 id="creating-asynchronous-methodshttpsspringioguidesgsasync-methodsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">Creating Asynchronous Methods</a></h2>
<h3 id="this-guide-walks-you-through-creating-asynchronous-queries-to-github-the-focus-is-on-the-asynchronous-part-a-featurehttpsspringioguidesgsasync-methodsourcepost5fpage-----44dd721f60e9--------------------------------"><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">This guide walks you through creating asynchronous queries to GitHub. The focus is on the asynchronous part, a feature…</a></h3>
<p><a href="https://spring.io/guides/gs/async-method/?source=post%5Fpage-----44dd721f60e9--------------------------------">spring.io</a></p>

    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">

<ul class="aside__social-links">
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    
    
        <p>
            By Marco Pegoraro, 
            2020-08-22
        </p>
    

    

                </div>
            </section>

            <footer class="page__footer"><p>
    
    
    
    
    
    
    
    
      
      
          
            
            
                <br/><span class="active">$ echo $LANG<br/><b></b></span><br/>

            
          
      
    
</p>
<br /><br />
<p class="copyright"></p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
</footer>

        </div>
    </body>

</html>
